name: Reusable - Backend Tests & Coverage

on:
  workflow_call:
    inputs:
      java_version:
        type: string
        default: "17"
      threshold:
        type: number
        default: 80
    outputs:
      coverage:
        description: "Backend line coverage percentage (integer)"
        value: ${{ jobs.back.outputs.coverage }}
      ok:
        description: "true if coverage >= threshold"
        value: ${{ jobs.back.outputs.ok }}

jobs:
  back:
    name: Backend â€¢ Tests + JaCoCo
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.setout.outputs.coverage }}
      ok: ${{ steps.setout.outputs.ok }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java_version }}
          cache: maven

      - name: Test + JaCoCo report
        working-directory: ./back
        run: mvn -B clean test jacoco:report

      - name: Compute line coverage %
        id: cov
        shell: bash
        run: |
          set -euo pipefail
          FILE="back/target/site/jacoco/jacoco.xml"
          if [[ ! -f "$FILE" ]]; then
            echo "jacoco.xml introuvable, coverage=0"
            echo "pct=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # extrait les compteurs de lignes (missed/covered)
          MISSED=$(grep -oP 'counter type="LINE" missed="\K[0-9]+' "$FILE" | paste -sd+ - | bc)
          COVERED=$(grep -oP 'counter type="LINE" missed="\d+" covered="\K[0-9]+' "$FILE" | paste -sd+ - | bc)
          : "${MISSED:=0}"; : "${COVERED:=0}"
          TOTAL=$((MISSED + COVERED))
          if [[ "$TOTAL" -eq 0 ]]; then PCT=0; else PCT=$((COVERED * 100 / TOTAL)); fi
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Š Backend line coverage = ${PCT}%"

      - name: Set outputs
        id: setout
        shell: bash
        run: |
          TH=${{ inputs.threshold }}
          PCT=${{ steps.cov.outputs.pct }}
          OK=false
          if [ "$PCT" -ge "$TH" ]; then OK=true; fi
          echo "coverage=$PCT" >> "$GITHUB_OUTPUT"
          echo "ok=$OK" >> "$GITHUB_OUTPUT"

      - name: Upload JaCoCo artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-jacoco
          path: back/target/site/jacoco/**
