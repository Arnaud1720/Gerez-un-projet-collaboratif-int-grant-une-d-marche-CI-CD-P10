name: CI Backend Tests

on:
  # Tests déclenchés automatiquement toutes les heures
  schedule:
    - cron: '0 * * * *'  # Toutes les heures
  # Tests sur push/PR vers la branche test-backend
  push:
    branches: [ test-backend ]
  pull_request:
    branches: [ test-backend ]
  # Permet de déclencher manuellement
  workflow_dispatch:

jobs:
  test-backend:
    name: Backend Tests & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run Backend Tests with Coverage
        working-directory: ./back
        run: mvn clean test jacoco:report

      - name: Extract Coverage Percentage
        id: coverage
        working-directory: ./back
        run: |
          # Extraction du taux de couverture depuis le rapport JaCoCo
          COVERAGE=$(grep -oP 'Total.*?(\d+)%' target/site/jacoco/index.html | grep -oP '\d+' | head -1 || echo "0")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Backend Coverage: $COVERAGE%"
 
      - name: Upload Backend Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-${{ github.run_number }}
          path: back/target/site/jacoco/

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const threshold = 80;
            const status = coverage >= threshold ? '✅' : '❌';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${status} Backend Coverage Report\n\n**Coverage:** ${coverage}%\n**Threshold:** ${threshold}%\n\n${coverage >= threshold ? 'Coverage requirement met!' : 'Coverage below required threshold!'}`
            })

      - name: Display Test Summary
        run: |
          echo " Backend Tests Complete"
          echo " Coverage: ${{ steps.coverage.outputs.coverage }}%"
          echo " Target: 80%"
