name: CD Pipeline - Main Deployment

# Ce workflow se d√©clenche uniquement sur la branche main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_docker:
        description: 'Skip Docker build and push'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  COVERAGE_THRESHOLD: 20  # Mode TEST √† 20%, √† augmenter √† 80% en production
  DOCKER_USERNAME: arnaudd3380
  BACKEND_IMAGE: bobapp-backend
  FRONTEND_IMAGE: bobapp-frontend

jobs:
  # ==================== JOB 1: QUALITY GATE ====================
  quality-gate:
    name: Verify Quality Gate (TEST MODE - ${{ github.event.repository.environment.COVERAGE_THRESHOLD || 20 }}%)
    runs-on: ubuntu-latest

    outputs:
      backend_coverage: ${{ steps.backend-coverage.outputs.coverage }}
      frontend_coverage: ${{ steps.frontend-coverage.outputs.coverage }}
      passed: ${{ steps.final-check.outputs.passed }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # ========== BACKEND TESTS ==========
      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: üì¶ Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: üß™ Run Backend Tests with Coverage
        working-directory: ./back
        run: mvn clean test jacoco:report

      - name: üìä Verify Backend Coverage >= ${{ env.COVERAGE_THRESHOLD }}%
        id: backend-coverage
        working-directory: ./back
        run: |
          COVERAGE=$(grep -oP 'Total.*?(\d+)%' target/site/jacoco/index.html | grep -oP '\d+' | head -1 || echo "0")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "üìä Backend Coverage: $COVERAGE%"
          
          if [ "$COVERAGE" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
            echo "‚ùå DEPLOYMENT BLOCKED: Backend coverage ($COVERAGE%) < ${{ env.COVERAGE_THRESHOLD }}%"
            echo "‚õî Cannot deploy to main branch with insufficient code coverage"
            echo "üî¥ TEST MODE: Threshold set to ${{ env.COVERAGE_THRESHOLD }}% for testing"
            exit 1
          else
            echo "‚úÖ Backend coverage requirement met ($COVERAGE% >= ${{ env.COVERAGE_THRESHOLD }}%)"
            echo "üü¢ TEST MODE: Threshold set to ${{ env.COVERAGE_THRESHOLD }}% for testing"
          fi

      # ========== FRONTEND TESTS ==========
      - name: üîß Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json

      - name: üì¶ Install Frontend dependencies
        working-directory: ./front
        run: npm ci

      - name: üß™ Run Frontend Tests with Coverage
        working-directory: ./front
        run: npm run test -- --watch=false --code-coverage --browsers=ChromeHeadless

      - name: üìä Verify Frontend Coverage >= ${{ env.COVERAGE_THRESHOLD }}%
        id: frontend-coverage
        working-directory: ./front
        run: |
          if [ -f "coverage/index.html" ]; then
            COVERAGE=$(grep -oP '\d+\.\d+(?=%)' coverage/index.html | head -1 | cut -d. -f1 || echo "0")
          elif [ -f "coverage/lcov-report/index.html" ]; then
            COVERAGE=$(grep -oP '\d+\.\d+(?=%)' coverage/lcov-report/index.html | head -1 | cut -d. -f1 || echo "0")
          else
            COVERAGE="0"
          fi
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "üìä Frontend Coverage: $COVERAGE%"
          
          if [ "$COVERAGE" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
            echo "‚ùå DEPLOYMENT BLOCKED: Frontend coverage ($COVERAGE%) < ${{ env.COVERAGE_THRESHOLD }}%"
            echo "‚õî Cannot deploy to main branch with insufficient code coverage"
            echo "üî¥ TEST MODE: Threshold set to ${{ env.COVERAGE_THRESHOLD }}% for testing"
            exit 1
          else
            echo "‚úÖ Frontend coverage requirement met ($COVERAGE% >= ${{ env.COVERAGE_THRESHOLD }}%)"
            echo "üü¢ TEST MODE: Threshold set to ${{ env.COVERAGE_THRESHOLD }}% for testing"
          fi

      # ========== FINAL CHECK ==========
      - name: ‚úÖ Final Quality Gate Check
        id: final-check
        run: |
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Quality Gate PASSED - All requirements met!"
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Quality Gate Report
          
          | Component | Coverage | Threshold | Status |
          |-----------|----------|-----------|--------|
          | Backend | ${{ steps.backend-coverage.outputs.coverage }}% | ${{ env.COVERAGE_THRESHOLD }}% | ‚úÖ |
          | Frontend | ${{ steps.frontend-coverage.outputs.coverage }}% | ${{ env.COVERAGE_THRESHOLD }}% | ‚úÖ |
          
          üéØ **Decision**: PROCEED WITH BUILD AND DEPLOYMENT
          EOF

      # ========== UPLOAD ARTIFACTS ==========
      - name: üì§ Upload Backend Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/

      - name: üì§ Upload Frontend Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: front/coverage/

  # ==================== JOB 2: SONARCLOUD ANALYSIS ====================
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [quality-gate]

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: üì¶ Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: üì¶ Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: üì• Download Backend Coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/

      - name: üîç Build and analyze Backend with SonarCloud
        working-directory: ./back
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=Arnaud1720_Gerez-un-projet-collaboratif-int-grant-une-d-marche-CI-CD-P10 \
            -Dsonar.organization=arnaud1720 \
            -Dsonar.host.url=https://sonarcloud.io

      - name: üìä Add SonarCloud results to summary
        run: |
          echo "## üîç SonarCloud Analysis" >> $GITHUB_STEP_SUMMARY
          echo "[View analysis on SonarCloud](https://sonarcloud.io/summary/new_code?id=Arnaud1720_Gerez-un-projet-collaboratif-int-grant-une-d-marche-CI-CD-P10)" >> $GITHUB_STEP_SUMMARY

  # ==================== JOB 3: BUILD APPLICATION ====================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [quality-gate, sonarcloud]

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # ========== BUILD BACKEND ==========
      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: üî® Build Backend
        working-directory: ./back
        run: |
          echo "Building backend application..."
          mvn clean package -DskipTests
          echo "‚úÖ Backend build successful"

      - name: üì§ Upload Backend JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: back/target/*.jar

      # ========== BUILD FRONTEND ==========
      - name: üîß Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üî® Build Frontend
        working-directory: ./front
        run: |
          echo "Building frontend application..."
          npm ci
          npm run build
          echo "‚úÖ Frontend build successful"

      - name: üì§ Upload Frontend Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: front/dist/

      - name: üìä Build Summary
        run: |
          echo "## üî® Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Backend JAR: ‚úÖ Built and uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend dist: ‚úÖ Built and uploaded" >> $GITHUB_STEP_SUMMARY

  # ==================== JOB 4: DOCKER BUILD & PUSH ====================
  docker:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: build
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      github.event.inputs.skip_docker != 'true'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì• Download Backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: back/target/

      - name: üì• Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: front/dist/

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üìù Generate Docker tags
        id: meta
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          SHORT_SHA=${GITHUB_SHA::7}
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: üê≥ Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./back
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.sha }}
            ${{ env.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.timestamp }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.timestamp }}

      - name: üê≥ Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./front
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.sha }}
            ${{ env.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.timestamp }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.timestamp }}

      - name: üìä Docker Push Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## üê≥ Docker Images Published
          
          ### Backend
          - \`${{ env.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE }}:latest\`
          - \`${{ env.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.sha }}\`
          - \`${{ env.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.timestamp }}\`
          
          ### Frontend
          - \`${{ env.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE }}:latest\`
          - \`${{ env.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.sha }}\`
          - \`${{ env.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.timestamp }}\`
          
          View on Docker Hub:
          - [Backend](https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE }})
          - [Frontend](https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE }})
          EOF

  # ==================== JOB 5: DEPLOYMENT SUMMARY ====================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [quality-gate, sonarcloud, build, docker]
    if: always()

    steps:
      - name: üìä Generate Final Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # üöÄ Deployment Pipeline Summary
          
          ## Pipeline Status
          
          | Job | Status |
          |-----|--------|
          | Quality Gate | ${{ needs.quality-gate.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | SonarCloud | ${{ needs.sonarcloud.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | Build | ${{ needs.build.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |
          | Docker Push | ${{ needs.docker.result == 'success' && '‚úÖ Success' || needs.docker.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }} |
          
          ## Coverage Results
          - Backend: ${{ needs.quality-gate.outputs.backend_coverage }}%
          - Frontend: ${{ needs.quality-gate.outputs.frontend_coverage }}%
          
          ## Deployment Information
          - **Branch**: \`${{ github.ref_name }}\`
          - **Commit**: \`${{ github.sha }}\`
          - **Triggered by**: ${{ github.actor }}
          - **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          EOF