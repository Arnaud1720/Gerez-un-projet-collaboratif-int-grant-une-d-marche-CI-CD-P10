name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: "17"
  NODE_VERSION: "18"
  COVERAGE_THRESHOLD: "20"
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_IMAGE_BACKEND: bobapp-backend
  DOCKER_IMAGE_FRONTEND: bobapp-frontend

jobs:
  # Etape 1: Tests Backend
  backend-tests:
    name: Etape 1 - Tests Backend
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.cov-back.outputs.pct }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Tests backend + JaCoCo
        working-directory: back
        run: mvn -B clean test jacoco:report

      - name: Calcul coverage backend
        id: cov-back
        working-directory: back
        shell: bash
        run: |
          set -euo pipefail
          XML="target/site/jacoco/jacoco.xml"
          if [[ -f "$XML" ]]; then
            MISSED=$(grep -o 'missed="[0-9]*"' "$XML" | grep -o '[0-9]*' | paste -sd+ - | bc)
            COVERED=$(grep -o 'covered="[0-9]*"' "$XML" | grep -o '[0-9]*' | paste -sd+ - | bc)
            TOTAL=$(( MISSED + COVERED ))
            PCT=$(( TOTAL > 0 ? (100 * COVERED) / TOTAL : 0 ))
          else
            PCT=0
          fi
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "Backend coverage: $PCT%"

      - name: Verification seuil backend
        shell: bash
        run: |
          if (( ${{ steps.cov-back.outputs.pct }} < ${{ env.COVERAGE_THRESHOLD }} )); then
            echo "Coverage backend insuffisant: ${{ steps.cov-back.outputs.pct }}% < ${{ env.COVERAGE_THRESHOLD }}%"; exit 1;
          fi

      - name: Upload rapport backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/**

  # Etape 2: Tests Frontend
  frontend-tests:
    name: Etape 2 - Tests Frontend
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.cov-front.outputs.pct }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: front/package-lock.json

      - name: Installer Chromium
        run: |
          sudo apt-get update
          (sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium)
          echo "CHROME_BIN=$(which chromium-browser || which chromium)" >> $GITHUB_ENV

      - name: Install dependencies
        working-directory: front
        run: npm ci

      - name: Tests avec coverage
        working-directory: front
        run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage

      - name: Calcul coverage frontend
        id: cov-front
        working-directory: front
        shell: bash
        run: |
          set -euo pipefail
          JSON=$(find coverage -type f -name "coverage-summary.json" -print -quit || true)
          if [[ -n "$JSON" ]]; then
            echo "coverage-summary.json trouve: $JSON"
            PCT=$(node -e '
              try {
                const s=require(process.argv[1]);
                const v=(s.total?.lines?.pct ?? s.total?.statements?.pct ?? 0);
                const n=Number.parseFloat(v);
                console.log(Number.isFinite(n)?Math.floor(n):0);
              } catch(e){console.log(0);}
            ' "$JSON")
          else
            LCOV=$(find coverage -type f -name "lcov.info" -print -quit || true)
            if [[ -n "$LCOV" ]]; then
              echo "lcov.info trouve: $LCOV"
              read TOTAL COVERED <<<"$(awk -F, '
                /^DA:/ {
                  split($0,a,":");
                  split(a[2],b,",");
                  total++; if (b[2]+0 > 0) covered++;
                }
                END { printf "%d %d", total, covered }
              ' "$LCOV")"
              if [[ "${TOTAL:-0}" -gt 0 ]]; then
                PCT=$(( (100 * COVERED) / TOTAL ))
              else
                PCT=0
              fi
            else
              PCT=0
            fi
          fi
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "Frontend coverage: $PCT%"

      - name: Verification seuil frontend
        shell: bash
        run: |
          if (( ${{ steps.cov-front.outputs.pct }} < ${{ env.COVERAGE_THRESHOLD }} )); then
            echo "Coverage frontend insuffisant: ${{ steps.cov-front.outputs.pct }}% < ${{ env.COVERAGE_THRESHOLD }}%"; exit 1;
          fi

      - name: Upload rapport frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: front/coverage/**

  # Etape 3: Analyse SonarCloud
  sonarcloud:
    name: Etape 3 - Analyse SonarCloud
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Telecharger coverage backend
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/

      - name: Telecharger coverage frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: front/coverage/

      - name: Analyse SonarCloud
        working-directory: back
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=Arnaud1720_Gerez-un-projet-collaboratif-int-grant-une-d-marche-CI-CD-P10 \
            -Dsonar.organization=arnaud1720 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.sources=src/main/java,../front/src \
            -Dsonar.tests=../front/src \
            -Dsonar.test.inclusions=**/*.spec.ts \
            -Dsonar.javascript.lcov.reportPaths=../front/coverage/**/lcov.info \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

  # Etape 4: Build et Push Docker Backend
  docker-backend:
    name: Etape 4 - Build et Push Docker Backend
    runs-on: ubuntu-latest
    needs: [sonarcloud]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./back
          file: ./back/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_BACKEND }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_BACKEND }}:main
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_BACKEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Etape 5: Build et Push Docker Frontend
  docker-frontend:
    name: Etape 5 - Build et Push Docker Frontend
    runs-on: ubuntu-latest
    needs: [sonarcloud]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./front
          file: ./front/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_FRONTEND }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_FRONTEND }}:main
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_FRONTEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
