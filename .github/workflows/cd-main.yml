name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: "17"
  NODE_VERSION: "18"
  COVERAGE_THRESHOLD: "20"

jobs:
  quality-gate:
    name: Étape 1-3 • Tests + coverage + upload rapports
    runs-on: ubuntu-latest
    outputs:
      backend_coverage: ${{ steps.outs.outputs.backend_coverage }}
      frontend_coverage: ${{ steps.outs.outputs.frontend_coverage }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ===== BACKEND =====
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Tests backend + JaCoCo
        working-directory: back
        run: mvn -B clean test jacoco:report

      - name: Calcul coverage backend (%)
        id: cov-back
        working-directory: back
        shell: bash
        run: |
          set -euo pipefail
          XML="target/site/jacoco/jacoco.xml"
          if [[ -f "$XML" ]]; then
            MISSED=$(grep -o 'missed="[0-9]*"' "$XML" | grep -o '[0-9]*' | paste -sd+ - | bc)
            COVERED=$(grep -o 'covered="[0-9]*"' "$XML" | grep -o '[0-9]*' | paste -sd+ - | bc)
            TOTAL=$(( MISSED + COVERED ))
            PCT=$(( TOTAL > 0 ? (100 * COVERED) / TOTAL : 0 ))
          else
            PCT=0
          fi
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "Backend coverage: $PCT%"

      - name: Vérif seuil backend
        shell: bash
        run: |
          if (( ${{ steps.cov-back.outputs.pct }} < ${{ env.COVERAGE_THRESHOLD }} )); then
            echo "Coverage backend insuffisant: ${{ steps.cov-back.outputs.pct }}% < ${{ env.COVERAGE_THRESHOLD }}%"; exit 1;
          fi

      - name: Upload rapport backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/**

      # ===== FRONTEND =====
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: front/package-lock.json

      - name: Installer Chromium (pour Karma)
        run: |
          sudo apt-get update
          (sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium)
          echo "CHROME_BIN=$(which chromium-browser || which chromium)" >> $GITHUB_ENV

      - name: Install deps front
        working-directory: front
        run: npm ci

      - name: Tests front avec coverage
        working-directory: front
        run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage

      - name: Debug coverage (ls + aperçus)
        working-directory: front
        shell: bash
        run: |
          set -e
          echo "PWD=$(pwd)"
          echo "--- tree coverage ---"
          find coverage -maxdepth 3 -type f -print || true
          echo "--- Aperçu coverage-summary.json ---"
          SUMMARY=$(find coverage -type f -name "coverage-summary.json" -print -quit || true)
          if [[ -n "$SUMMARY" ]]; then
            head -c 1000 "$SUMMARY" || true
            echo "--- fin summary ---"
          fi
          echo "--- Aperçu lcov.info ---"
          LCOV=$(find coverage -type f -name "lcov.info" -print -quit || true)
          if [[ -n "$LCOV" ]]; then
            head -n 20 "$LCOV" || true
            echo "--- fin lcov ---"
          fi

      - name: Calcul coverage frontend (%)
        id: cov-front
        working-directory: front
        shell: bash
        run: |
          set -euo pipefail

          # 1) coverage-summary.json (Istanbul)
          JSON=$(find coverage -type f -name "coverage-summary.json" -print -quit || true)
          if [[ -n "$JSON" ]]; then
            echo "coverage-summary.json trouvé: $JSON"
            PCT=$(node -e '
              try {
                const s=require(process.argv[1]);
                const v=(s.total?.lines?.pct ?? s.total?.statements?.pct ?? 0);
                const n=Number.parseFloat(v);
                console.log(Number.isFinite(n)?Math.floor(n):0);
              } catch(e){console.log(0);}
            ' "$JSON")
          else
            # 2) lcov.info (Istanbul): compter DA:<line>,<hits>
            LCOV=$(find coverage -type f -name "lcov.info" -print -quit || true)
            if [[ -n "$LCOV" ]]; then
              echo "lcov.info trouvé: $LCOV"
              read TOTAL COVERED <<<"$(awk -F, '
                /^DA:/ {
                  split($0,a,":");       # a[2] = "<line>,<hits>"
                  split(a[2],b,",");     # b[1]=line, b[2]=hits
                  total++; if (b[2]+0 > 0) covered++;
                }
                END { printf "%d %d", total, covered }
              ' "$LCOV")"
              if [[ "${TOTAL:-0}" -gt 0 ]]; then
                PCT=$(( (100 * COVERED) / TOTAL ))
              else
                PCT=0
              fi
            else
              echo "⚠️ Aucun rapport coverage trouvé sous $(pwd)/coverage/"
              PCT=0
            fi
          fi

          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "Frontend coverage: $PCT%"

      - name: Vérif seuil frontend
        shell: bash
        run: |
          if (( ${{ steps.cov-front.outputs.pct }} < ${{ env.COVERAGE_THRESHOLD }} )); then
            echo "Coverage frontend insuffisant: ${{ steps.cov-front.outputs.pct }}% < ${{ env.COVERAGE_THRESHOLD }}%"; exit 1;
          fi

      - name: Upload rapport frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: front/coverage/**

      - name: Expose outputs
        id: outs
        run: |
          echo "backend_coverage=${{ steps.cov-back.outputs.pct }}" >> "$GITHUB_OUTPUT"
          echo "frontend_coverage=${{ steps.cov-front.outputs.pct }}" >> "$GITHUB_OUTPUT"

  # === Étape SonarCloud ===
  sonarcloud:
    name: Étape 4 • Analyse SonarCloud
    runs-on: ubuntu-latest
    needs: quality-gate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Télécharger coverage backend
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/

      - name: Télécharger coverage frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: front/coverage/

      - name: Analyse SonarCloud (Maven)
        working-directory: back
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=Arnaud1720_Gerez-un-projet-collaboratif-int-grant-une-d-marche-CI-CD-P10 \
            -Dsonar.organization=arnaud1720 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.sources=src/main/java,../front/src \
            -Dsonar.tests=../front/src \
            -Dsonar.test.inclusions=**/*.spec.ts \
            -Dsonar.javascript.lcov.reportPaths=../front/coverage/**/lcov.info \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
