name: Main - Quality Gate (20% mini) + Sonar + Build + Docker

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: "17"
  NODE_VERSION: "20"
  COVERAGE_THRESHOLD: "20"     # seuil mini (peut être monté à 80)
  DOCKER_IMAGE_BACK: "app-back"
  DOCKER_IMAGE_FRONT: "app-front"

jobs:
  quality-gate:
    name: Etape 1-3 • Récupération + vérif coverage branches distantes + upload rapports
    runs-on: ubuntu-latest
    outputs:
      backend_coverage: ${{ steps.outs.outputs.backend_coverage }}
      frontend_coverage: ${{ steps.outs.outputs.frontend_coverage }}
    steps:
      # ===== BACKEND : branch distante test-backend =====
      - name: Checkout test-backend (dans repo-back)
        uses: actions/checkout@v4
        with:
          ref: test-backend
          path: repo-back

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Tests backend + JaCoCo
        working-directory: repo-back/back
        run: mvn -B clean test jacoco:report

      - name: Calcul coverage backend (%)
        id: cov-back
        shell: bash
        run: |
          FILE="repo-back/back/target/site/jacoco/jacoco.xml"
          if [[ ! -f "$FILE" ]]; then echo "pct=0" >> "$GITHUB_OUTPUT"; exit 0; fi
          MISSED=$(grep -oP 'counter type="LINE" missed="\K[0-9]+' "$FILE" | paste -sd+ - | bc)
          COVERED=$(grep -oP 'counter type="LINE" missed="\d+" covered="\K[0-9]+' "$FILE" | paste -sd+ - | bc)
          : "${MISSED:=0}"; : "${COVERED:=0}"
          TOTAL=$((MISSED + COVERED))
          if [[ "$TOTAL" -eq 0 ]]; then PCT=0; else PCT=$((COVERED * 100 / TOTAL)); fi
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "Backend coverage: $PCT%"

      - name: Vérif seuil backend
        shell: bash
        run: |
          if (( ${{ steps.cov-back.outputs.pct }} < ${{ env.COVERAGE_THRESHOLD }} )); then
            echo "Coverage backend insuffisant: ${{ steps.cov-back.outputs.pct }}% < ${{ env.COVERAGE_THRESHOLD }}%"; exit 1;
          fi

      - name: Upload rapport backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: repo-back/back/target/site/jacoco/**

      # ===== FRONTEND : branch distante test-frontend =====
      - name: Checkout test-frontend (dans repo-front)
        uses: actions/checkout@v4
        with:
          ref: test-frontend
          path: repo-front

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: /front/package-lock.json

      - name: Install deps front
        working-directory: /front
        run: npm ci

      - name: Tests front avec coverage
        working-directory: /front
        run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage

      - name: Calcul coverage frontend (%)
        id: cov-front
        working-directory: /front
        shell: bash
        run: |
          set -euo pipefail
          # 1) Essayer coverage-summary.json (Istanbul/Jest/Karma)
          JSON=$(find coverage -type f -name "coverage-summary.json" -print -quit || true)
          if [[ -n "$JSON" ]]; then
            echo "Fichier coverage-summary.json trouvé: $JSON"
            PCT=$(node -e 'const s=require(process.argv[1]); const v=(s.total?.lines?.pct ?? s.total?.statements?.pct ?? 0); console.log(Math.floor(v));' "$JSON")
          else
            # 2) Retombée sur lcov.info (Angular --code-coverage)
            LCOV=$(find coverage -type f -name "lcov.info" -print -quit || true)
            if [[ -n "$LCOV" ]]; then
              echo "Fichier lcov.info trouvé: $LCOV"
              LH=$(grep -o '^LH:[0-9]\+' "$LCOV" | awk -F: '{s+=$2} END{print s+0}')
              LF=$(grep -o '^LF:[0-9]\+' "$LCOV" | awk -F: '{s+=$2} END{print s+0}')
              if [[ "${LF:-0}" -gt 0 ]]; then
                PCT=$(( (100 * LH) / LF ))
              else
                PCT=0
              fi
            else
              echo "Aucun rapport de coverage trouvé dans $(pwd)/coverage/"
              PCT=0
            fi
          fi
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "Frontend coverage: $PCT%"

      - name: Vérif seuil frontend
        shell: bash
        run: |
          if (( ${{ steps.cov-front.outputs.pct }} < ${{ env.COVERAGE_THRESHOLD }} )); then
            echo "Coverage frontend insuffisant: ${{ steps.cov-front.outputs.pct }}% < ${{ env.COVERAGE_THRESHOLD }}%"; exit 1;
          fi

      - name: Upload rapport frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: /front/coverage/**

      - name: Expose outputs
        id: outs
        run: |
          echo "backend_coverage=${{ steps.cov-back.outputs.pct }}" >> "$GITHUB_OUTPUT"
          echo "frontend_coverage=${{ steps.cov-front.outputs.pct }}" >> "$GITHUB_OUTPUT"

  sonarcloud:
    name: Etape 4 • SonarCloud Analysis (avec chemins explicites vers rapports)
    runs-on: ubuntu-latest
    needs: quality-gate
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Télécharger coverage backend
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/

      - name: Télécharger coverage frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: front/coverage/

      - name: Analyse SonarCloud
        working-directory: ./back
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=Arnaud1720_Gerez-un-projet-collaboratif-int-grant-une-d-marche-CI-CD-P10 \
            -Dsonar.organization=arnaud1720 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.sources=src/main/java,../front/src \
            -Dsonar.tests=../front/src \
            -Dsonar.test.inclusions=**/*.spec.ts \
            -Dsonar.javascript.lcov.reportPaths=../front/coverage/**/lcov.info \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

  build:
    name: Etapes 5-7 • Build backend + frontend + artefacts
    runs-on: ubuntu-latest
    needs: sonarcloud
    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      # Backend
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build backend (skip tests)
        working-directory: ./back
        run: mvn -B -DskipTests package

      - name: Upload JAR backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: back/target/*.jar

      # Frontend
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: front/package-lock.json

      - name: Build frontend (prod)
        working-directory: ./front
        run: |
          npm ci
          npm run build -- --configuration production

      - name: Upload build frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: front/dist/**

  docker:
    name: Etape 8 • Docker build & push Docker Hub
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Télécharger JAR backend
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: back/target/

      - name: Télécharger dist frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: front/dist/

      - name: Normaliser username Docker Hub
        id: who
        shell: bash
        run: |
          USER="$(printf '%s' '${{ secrets.DOCKERHUB_USERNAME }}' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')"
          echo "user=$USER" >> "$GITHUB_OUTPUT"

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ steps.who.outputs.user }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tags
        id: tags
        shell: bash
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "tag1=latest" >> "$GITHUB_OUTPUT"
          echo "tag2=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./back
          file: ./back/Dockerfile
          push: true
          tags: |
            ${{ steps.who.outputs.user }}/${{ env.DOCKER_IMAGE_BACK }}:${{ steps.tags.outputs.tag1 }}
            ${{ steps.who.outputs.user }}/${{ env.DOCKER_IMAGE_BACK }}:${{ steps.tags.outputs.tag2 }}

      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./front
          file: ./front/Dockerfile
          push: true
          tags: |
            ${{ steps.who.outputs.user }}/${{ env.DOCKER_IMAGE_FRONT }}:${{ steps.tags.outputs.tag1 }}
            ${{ steps.who.outputs.user }}/${{ env.DOCKER_IMAGE_FRONT }}:${{ steps.tags.outputs.tag2 }}
