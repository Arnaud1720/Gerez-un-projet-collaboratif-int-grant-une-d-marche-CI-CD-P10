name: Reusable - Frontend Tests & Coverage

on:
  workflow_call:
    inputs:
      node_version:
        type: string
        default: "20"
      threshold:
        type: number
        default: 80
    outputs:
      coverage:
        description: "Frontend coverage percentage (integer)"
        value: ${{ jobs.front.outputs.coverage }}
      ok:
        description: "true if coverage >= threshold"
        value: ${{ jobs.front.outputs.ok }}

jobs:
  front:
    name: Frontend â€¢ Tests + Coverage
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.setout.outputs.coverage }}
      ok: ${{ steps.setout.outputs.ok }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: front/package-lock.json

      - name: Install deps
        working-directory: ./front
        run: npm ci

      - name: Test (with coverage)
        working-directory: ./front
        run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage

      - name: Compute coverage %
        id: cov
        working-directory: ./front
        shell: bash
        run: |
          set -euo pipefail
          JSON_REPORT=$(find coverage -type f -name "coverage-summary.json" -print -quit || true)
          if [[ -z "${JSON_REPORT}" ]]; then
            # fallback via lcov.info
            LCOV=$(find coverage -type f -name "lcov.info" -print -quit || true)
            if [[ -n "${LCOV}" ]]; then
              PCT=$(awk 'BEGIN{lh=0;lf=0} /^LH:/{sub("LH:","",$1);lh+=$1} /^LF:/{sub("LF:","",$1);lf+=$1} END{if(lf>0) printf("%d",(lh*100)/lf); else print 0}' "$LCOV")
            else
              PCT=0
            fi
          else
            PCT=$(node -e "console.log(Math.floor(require(process.argv[1]).total.lines.pct))" "$JSON_REPORT")
          fi
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Š Frontend coverage = ${PCT}%"

      - name: Set outputs
        id: setout
        shell: bash
        run: |
          TH=${{ inputs.threshold }}
          PCT=${{ steps.cov.outputs.pct }}
          OK=false
          if [ "$PCT" -ge "$TH" ]; then OK=true; fi
          echo "coverage=$PCT" >> "$GITHUB_OUTPUT"
          echo "ok=$OK" >> "$GITHUB_OUTPUT"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: |
            front/coverage/**/coverage-summary.json
            front/coverage/**/lcov.info
            front/coverage/**/index.html
            front/coverage/**
