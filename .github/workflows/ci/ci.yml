name: CI - Tests & Coverage Gate

on:
  push:
    branches: [ main, develop, test-frontend, test-backend ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  # ==================== TESTS ====================
  frontend-tests:
    name: Frontend â€¢ Tests & Coverage
    uses: ./.github/workflows/ci-frontend.yml
    with:
      node_version: "20"
      threshold: 80

  backend-tests:
    name: Backend â€¢ Tests & Coverage
    uses: ./.github/workflows/ci-backend.yml
    with:
      java_version: "17"
      threshold: 80

  # ==================== QUALITY GATE ====================
  coverage-gate:
    name: Coverage Gate Check
    needs: [ frontend-tests, backend-tests ]
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Check Coverage Requirements
        id: check
        run: |
          echo "ðŸ“Š Coverage Report:"
          echo "â”œâ”€ Frontend: ${{ needs.frontend-tests.outputs.coverage }}% (threshold: 80%)"
          echo "â””â”€ Backend: ${{ needs.backend-tests.outputs.coverage }}% (threshold: 80%)"
          
          FRONT_OK=${{ needs.frontend-tests.outputs.ok }}
          BACK_OK=${{ needs.backend-tests.outputs.ok }}
          
          if [[ "$FRONT_OK" == "true" && "$BACK_OK" == "true" ]]; then
            echo "âœ… Coverage gate PASSED - All coverage requirements met"
            echo "passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ Coverage gate FAILED - Minimum 80% coverage required"
            echo "passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

  # ==================== TRIGGER CD ====================
  trigger-cd:
    name: Trigger CD Pipeline
    needs: [ coverage-gate ]
    if: github.ref == 'refs/heads/main' && needs.coverage-gate.outputs.passed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger CD Workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-cd
          client-payload: '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'
      
      - name: CD Trigger Summary
        run: |
          echo "ðŸš€ CD Pipeline triggered successfully"
          echo "â”œâ”€ Branch: ${{ github.ref_name }}"
          echo "â””â”€ Commit: ${{ github.sha }}"
